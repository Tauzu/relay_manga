<!DOCTYPE html>
<html>
<head>
    <title>{{ page.manga.title }} - Page {{ page.id }}</title>
</head>
<body>
    <h1>{{ page.manga.title }} - Page {{ page.id }}</h1>
    <p>Author: {{ page.author.username }}</p>
    <p>作成日時: {{ page.created_at }}</p>
    <div>
        <img src="{{ page.image.url }}" alt="Page image" style="max-width:80%; border:1px solid #ccc;">
    </div>

    <p>いいね数: <span id="like-count">{{ page.likes }}</span></p>

    <form id="like-form" method="post" action="{% url 'like_page' page.id %}">
        {% csrf_token %}
        <button type="submit" id="like-button"
            {% if liked %}disabled{% endif %}>
            {% if liked %}👍 いいね済み{% else %}👍 いいね{% endif %}
        </button>
    </form>

    <script>
    document.getElementById("like-form").addEventListener("submit", function(event) {
        event.preventDefault();
        fetch(this.action, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("like-count").innerText = data.likes;
            if (data.already) {
                document.getElementById("like-button").disabled = true;
                document.getElementById("like-button").innerText = "👍 いいね済み";
            }
        });
    });
    </script>

    <hr>

    {% if parent %}
        <p><a href="{% url 'page_detail' parent.id %}">← 前のページへ (Page {{ parent.id }})</a></p>
    {% endif %}

    {% if next_page %}
        <p><a href="{% url 'page_detail' next_page.id %}">次のページへ (Page {{ next_page.id }}) →</a></p>
    {% endif %}

    <hr>

    <h3>このページの分岐先</h3>
    <ul>
        {% for child in children %}
            <li>
                <a href="{% url 'page_detail' child.id %}">
                    Page {{ child.id }} by {{ child.author.username }} (優先度: {{ child.priority }})
                </a>
            </li>
        {% empty %}
            <li>分岐はまだありません。</li>
        {% endfor %}
    </ul>

    <p>
        <a href="{% url 'continue_page' page.id %}">このページから続きを描く</a>
    </p>
    <p>
        <a href="{% url 'manga_detail' page.manga.id %}">← マンガに戻る</a>
    </p>
</body>
</html>
